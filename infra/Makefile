# Azure OpenAI Infrastructure - Development Makefile
.PHONY: help install install-dev clean format lint test security check-all deploy-dry deploy validate

# Default target
help: ## Show this help message
	@echo "ðŸ—ï¸ Azure OpenAI Infrastructure - Development Commands"
	@echo "===================================================="
	@echo ""
	@echo "ðŸš€ Setup & Environment:"
	@awk 'BEGIN {FS = ":.*##"} /^[a-zA-Z_-]+:.*##.*Install|Upgrade|Setup/ {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "ðŸŽ¨ Code Quality:"
	@awk 'BEGIN {FS = ":.*##"} /^[a-zA-Z_-]+:.*##.*Format|Lint|Test|Security|Quality/ {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "â˜ï¸ Azure Deployment:"
	@awk 'BEGIN {FS = ":.*##"} /^[a-zA-Z_-]+:.*##.*Deploy|Azure|Validate/ {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "ðŸ”§ Utilities & Status:"
	@awk 'BEGIN {FS = ":.*##"} /^[a-zA-Z_-]+:.*##.*Show|Check|Verify|Clean/ {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""

# Installation targets
install: ## Install production dependencies only
	@echo "ðŸ“¦ Installing production dependencies..."
	poetry install --only main

install-dev: ## Install all dependencies including dev tools
	@echo "ðŸ”§ Installing all dependencies (including dev tools)..."
	poetry install --with dev
	@echo "ðŸª Setting up pre-commit hooks..."
	pre-commit install

install-pip: ## Install using pip (alternative to poetry)
	@echo "ðŸ“¦ Installing with pip..."
	pip install -r requirements.txt
	pip install -r dev-requirements.txt

upgrade-python: ## Upgrade to Python 3.13 (simple)
	@echo "ðŸ Upgrading to Python 3.13..."
	powershell -ExecutionPolicy Bypass -File scripts/upgrade-python-simple-infra.ps1 -Force

upgrade-python-advanced: ## Upgrade to Python 3.13 (advanced diagnostics)
	@echo "ðŸ Advanced Python 3.13 upgrade..."
	powershell -ExecutionPolicy Bypass -File scripts/upgrade-python-infra.ps1 -Force -VerboseOutput

# Code quality targets
format: ## Format code with black and isort
	@echo "ðŸŽ¨ Formatting code..."
	black --line-length 79 --extend-exclude="\.venv.*" .
	isort --profile black --line-length 79 --skip .venv .

lint: ## Run linting with flake8 and mypy
	@echo "ðŸ” Running linters..."
	flake8 . --max-line-length=79 --extend-ignore=E203,W503 --exclude=.venv*,__pycache__,.git
	mypy . --config-file=pyproject.toml --exclude=".venv.*"

# Testing targets
test: ## Run tests with pytest
	@echo "ðŸ§ª Running tests..."
	pytest --cov=. --cov-report=term-missing --cov-report=html --ignore=.venv*

test-verbose: ## Run tests with verbose output
	@echo "ðŸ§ª Running tests (verbose)..."
	pytest -v --cov=. --cov-report=term-missing --cov-report=html

# Security targets
security: ## Run security scans
	@echo "ðŸ”’ Running security scans..."
	bandit -r . -f txt --exclude './.venv*,./tests'
	safety check
	pip-audit

security-json: ## Run security scans with JSON output
	@echo "ðŸ“Š Generating security reports..."
	mkdir -p reports
	bandit -r . -f json -o reports/bandit-report.json --exclude './.venv*,./tests'
	safety check --json > reports/safety-report.json
	pip-audit --format=json --output=reports/pip-audit-report.json
	@echo "Reports saved in reports/"

# Combined quality checks
check-all: format lint test security ## Run all quality checks
	@echo "âœ… All quality checks completed!"

pre-commit: ## Run pre-commit hooks on all files
	@echo "ðŸª Running pre-commit hooks..."
	pre-commit run --all-files

# Azure deployment targets
validate-env: ## Validate environment configuration
	@echo "ðŸ”§ Validating environment configuration..."
	python scripts/validate_env_config.py --verbose

deploy-dry: validate-env ## Run deployment dry-run
	@echo "ðŸ” Running deployment dry-run..."
	python create_ai_foundry_project.py --dry-run

deploy: validate-env ## Deploy to Azure
	@echo "ðŸš€ Deploying to Azure..."
	python create_ai_foundry_project.py

validate: ## Validate deployed resources
	@echo "âœ… Validating deployment..."
	python validate_ai_foundry_deployment.py

# Cleanup targets
clean: ## Clean up generated files
	@echo "ðŸ§¹ Cleaning up..."
	rm -rf .pytest_cache
	rm -rf .mypy_cache
	rm -rf __pycache__
	rm -rf *.egg-info
	rm -rf .coverage
	rm -rf htmlcov
	rm -rf *.log
	rm -rf *-report.json
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete

clean-all: clean ## Clean everything including virtual environment
	@echo "ðŸ§¹ Deep cleaning..."
	rm -rf .venv_infra
	rm -rf poetry.lock

# Development helpers
deps-update: ## Update dependencies
	@echo "ðŸ“¦ Updating dependencies..."
	poetry update

deps-show: ## Show dependency tree
	@echo "ðŸ“‹ Dependency tree:"
	poetry show --tree

deps-export: ## Export requirements files
	@echo "ðŸ“¤ Exporting requirements..."
	poetry export -f requirements.txt --output requirements.txt --only main
	poetry export -f requirements.txt --output dev-requirements.txt --only dev

python-info: ## Show Python environment info
	@echo "ðŸ Python Environment Information:"
	@echo "Python version: $$(python --version 2>/dev/null || echo 'Not available')"
	@echo "Python executable: $$(python -c 'import sys; print(sys.executable)' 2>/dev/null || echo 'Not available')"
	@echo "Virtual environment: $$(echo $$VIRTUAL_ENV || echo 'Not activated')"
	@echo "Poetry environment: $$(poetry env info --path 2>/dev/null || echo 'Not available')"

# Azure CLI helpers
az-login: ## Login to Azure CLI
	@echo "ðŸ” Logging into Azure..."
	az login

az-context: ## Show Azure context
	@echo "ðŸ“‹ Azure context:"
	az account show

# Quick development workflow
quick-check: format lint ## Quick code quality check
	@echo "âš¡ Quick quality check completed!"

# Complete setup workflow
dev-setup: upgrade-python install-dev pre-commit ## Complete development setup
	@echo "ðŸŽ‰ Development environment ready!"

quick-start: install-dev format lint ## Quick start for existing environment
	@echo "âš¡ Environment ready for development!"

# CI/CD simulation
ci-test: ## Simulate CI/CD pipeline
	@echo "ðŸ”„ Simulating CI/CD pipeline..."
	$(MAKE) clean
	$(MAKE) install-dev
	$(MAKE) format
	$(MAKE) lint
	$(MAKE) test
	$(MAKE) security
	$(MAKE) deploy-dry
	@echo "âœ… CI/CD simulation completed!"

# Environment verification
verify-python: ## Verify Python 3.13 setup
	@echo "ðŸ” Verifying Python setup..."
	@python scripts/validate_env_config.py --python-check 2>/dev/null || python scripts/verify-python.py 2>/dev/null || echo "Python verification script not found"

check-tools: ## Check that all development tools are working
	@echo "ðŸ§ª Checking development tools..."
	@python -c "import sys; print(f'âœ… Python {sys.version}')" 2>/dev/null || echo "âŒ Python not working"
	@black --version >/dev/null 2>&1 && echo "âœ… black" || echo "âŒ black"
	@isort --version >/dev/null 2>&1 && echo "âœ… isort" || echo "âŒ isort"
	@flake8 --version >/dev/null 2>&1 && echo "âœ… flake8" || echo "âŒ flake8"
	@mypy --version >/dev/null 2>&1 && echo "âœ… mypy" || echo "âŒ mypy"
	@pytest --version >/dev/null 2>&1 && echo "âœ… pytest" || echo "âŒ pytest"
	@bandit --version >/dev/null 2>&1 && echo "âœ… bandit" || echo "âŒ bandit"

# Status checks
status: ## Show comprehensive status
	@echo "ðŸ“Š Infrastructure Status"
	@echo "======================="
	@$(MAKE) python-info
	@echo ""
	@echo "ðŸ”§ Development Tools:"
	@$(MAKE) check-tools 2>/dev/null
	@echo ""
	@echo "ðŸ“ Files:"
	@echo "Virtual env: $$([ -d .venv_infra ] && echo 'âœ… .venv_infra exists' || echo 'âŒ .venv_infra missing')"
	@echo "Poetry config: $$([ -f pyproject.toml ] && echo 'âœ… pyproject.toml' || echo 'âŒ pyproject.toml missing')"
	@echo "Environment config: $$([ -f .env ] && echo 'âœ… .env exists' || echo 'âš ï¸ .env missing (copy from .env.example)')"
	@echo ""
	@echo "â˜ï¸ Azure:"
	@echo "Azure CLI: $$(az --version 2>/dev/null | head -1 || echo 'Not installed')"
	@echo "Azure context: $$(az account show --query name -o tsv 2>/dev/null || echo 'Not logged in')"
	@echo ""
	@echo "ðŸ“‹ Git:"
	@git status --porcelain | wc -l | xargs -I {} echo "Modified files: {}"
